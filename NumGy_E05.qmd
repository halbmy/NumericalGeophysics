---
title: "Numerical Simulation Methods in Geophysics, Exercise 5: Finite Elements"
subtitle: "1. MGPY+MGIN"
author: "thomas.guenther@geophysik.tu-freiberg.de"
title-slide-attributes:
  data-background-image: pics/tubaf-logo.png
  data-background-size: 20%
  data-background-position: 10% 95%
format:
  tubaf-revealjs:
    html-math-method: mathjax
    chalkboard: true
    include-in-header:
        - text: |
            <script>
            window.MathJax = {
            loader: {
                load: ['[tex]/physics']
            },
            tex: {
                packages: {'[+]': ['physics']}
            }
            };
            </script>
    slide-number: c/t
    transition: slide
    transition-speed: fast
    menu:
      side: left
# jupyter: python3
---
# Recap time-stepping in FD

| | | | | | |
|-------------|-------------:|-|-|-:|-|
|**Explicit**:||$\vb u^{n+1}$|$=$|$(\vb I - \Delta t \vb A)$|$\vb u^n$|
|**Implicit**:|$(\vb I + \Delta t \vb A)$|$\vb u^{n+1}$|$=$||$\vb u^n$|
|**Mixed**:|$(2\vb I + \Delta t \vb A)$|$\vb u^{n+1}$|$=$|$(2\vb I - \Delta t \vb A)$|$\vb u^n$|

:::: {.columns}
::: {.column width="33%"}
![Explicit](pics/dtforward.svg)
:::
::: {.column width="33%"}
![Implicit](pics/dtbackward.svg)
:::
::: {.column width="33%"}
![Mixed](pics/dtmixed.svg)
:::
::::

## The FE stiffness matrix

Matrix integrating gradients of base functions for neighbors with $a$

$$ \vb A_{i, i+1} = -\frac{a_i}{\Delta x_i^2} \vdot \Delta x_i = -\frac{a_i}{\Delta x_i} $$

$$ A_{i,i} = \int_\Omega a \grad v_i \cdot \grad v_i \dd\Omega = -A_{i,i+1} - A_{i+1,i}  $$

$\Rightarrow$ matrix-vector equation $\vb A \vb u = \vb b$ with bending&shear stiffness in $\vb A$

## Right-hand side vector

The right-hand-side vector $b=\int v_i f \dd\Gamma$ also scales with $\Delta x$

e.g. $f=\div \vb j_s$ $\Rightarrow$
$b=\int v_i \div \vb j_s \dd\Omega = \int_\Gamma v_i \vb j_S \cdot \vb n$

RHS = integrated source function (includes $\Delta x$)

(both $\vb A$ and $\vb b$ identical to FD for $\Delta x$=1)

:::{.callout-tip icon="false" title="Difference of FE to FD"}
Any source function $f(x)$ can be integrated on the whole space!
:::

## Right-hand side vector

:::: {.columns}
::: {.column}
```{python}
#| eval: true
#| echo: false
import numpy as np
import matplotlib.pyplot as plt
x = np.array([-1, 0, 1])
y = np.array([0, 1, 0])
fig, ax = plt.subplots()
ax.plot(x, y, "-")
ax.set_aspect(1.0)
ax.set_xticks(x)
ax.set_xticklabels(["-dx", "0", "dx"])
ax.grid()
```
:::
::: {.column}
$$ b_i = \int v_i f dx $$

Area: $\Delta x_{i-1}/2 + \Delta x_i/2$
:::
::::

$$ b_i = \int_{-\Delta x}^0 \frac{x+\Delta x}{\Delta x} + \int^{\Delta x}_0 1-\frac{x}{\Delta x} = \Delta x_{i-1}/2 + \Delta x_i/2 $$



## Tasks

1. Write a function computing the FE stiffness matrix for 1D discretization
1. Test it by solving the Poisson equation with $f=1$
1. Compare with analytical solution
1. Compute FD solution and compare with FE
1. Change discretization and check again
1. Change conductivity & compare FD and FE

## Analytical solution for $f$=1

$$u(x) = -\frac{1}{2} x^2 + C_1 x + C_0 \quad\Rightarrow\quad u'(x) = -x+C_1$$

| BC $x$=0 | BC $x=X$ |$C_0$ |$C_1$               |
|----------|----------|------|--------------------|
|Dirichlet |Dirichlet |$u_0$ |$X/2+(u_X-u_0)/X$   |
|Dirichlet |Neumann   |$u_0$ |$u'_X+X$            |
|Neumann   |Dirichlet |$u'_0$|$u_X-u'_0 X + X^2/2$|



# Time-stepping in FE
## Variational formulation of Diffusion equation

$$ \pdv{u}{t} - \div a \grad u = f $$

Finite Difference in Time (NOT in space)

$$ \frac{u^{n+1}-u^n}{\Delta t} - \div a \grad u = f $$

## Variational formulation
$$ \frac{u^{n+1}-u^n}{\Delta t} - \div a \grad u = f $$

::: {.fragment}
Multiplication with test function $w$ and integration $\Rightarrow$ weak form

$$ 1/\Delta t (\int_\Omega w u^{n+1}\dd\Omega-\int_\Omega w u^{n}\dd\Omega) - \int_\Omega w \div a \grad u \dd\Omega = \int_\Omega w f \dd\Omega $$
:::

::: {.fragment}
$$ 1/\Delta t (\int_\Omega w u^{n+1}\dd\Omega-\int_\Omega w u^{n}\dd\Omega) - \int_\Omega a \grad w \cdot \grad u \dd\Omega = \int_\Omega w f \dd\Omega $$
:::

## Variational formulation of Diffusion equation

$u$ is constructed of shape functions $\vb v_i$ that are identical to $w$

The integral over the Poisson term $\int_\Omega a \grad w \cdot \grad u \dd\Omega$ is represented using the stiffness matrix $\vb A \vb v$

$$ \vb A_{i,j} = \int_\Omega \sigma \grad v_i \cdot \grad v_j \dd\Omega $$

## Variational formulation of Poisson equation

Weighted integrals over both $u$ are represented by the mass matrix $\vb M \vb v$
$$ \vb M_{i,j} = \int_\Omega v_i \cdot v_j \dd\Omega $$

explicit method: $\vb M \vb u^{n+1} = (\vb M - \vb A)\vb u^n$

implicit method: $(\vb M + \vb A) \vb u^{n+1} = \vb M \vb u^n$

mixed method: $(\vb M + \vb A/2) \vb u^{n+1} = (\vb M - \vb A/2) \vb u^n$

same as in FD but with FE mass matrix

## Time-stepping in FE

| | | | | | |
|-------------|-------------:|-|-|-:|-|
|**Explicit**:|$\vb M$|$\vb u^{n+1}$|$=$|$(\vb M - \Delta t \vb A)$|$\vb u^n$|
|**Implicit**:|$(\vb M + \Delta t \vb A)$|$\vb u^{n+1}$|$=$|$\vb M$|$\vb u^n$|
|**Mixed**:|$(2\vb M + \Delta t \vb A)$|$\vb u^{n+1}$|$=$|$(2\vb M - \Delta t \vb A)$|$\vb u^n$|

:::: {.columns}
::: {.column width="33%"}
![Explicit](pics/dtforward.svg)
:::
::: {.column width="33%"}
![Implicit](pics/dtbackward.svg)
:::
::: {.column width="33%"}
![Mixed](pics/dtmixed.svg)
:::
::::

## Tasks

1. Write a function computing the FE stiffness matrix for 1D discretization
1. Test it by solving the Poisson equation with $f=1$ (analytical solution)
1. Compare with analytical and FD solutions
1. Write a function computing the FE mass matrix for 1D discretization
1. Repeat the time-stepping tasks from FD with FE
