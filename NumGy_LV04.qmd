---
title: "Numerical Simulation Methods in Geophysics, Part 4: Other equations"
subtitle: "1. MGPY+MGIN"
author: "thomas.guenther@geophysik.tu-freiberg.de"
title-slide-attributes:
  data-background-image: pics/tubaf-logo.png
  data-background-size: 20%
  data-background-position: 10% 95%
format:
  tubaf-revealjs:
    html-math-method: mathjax
    chalkboard: true
    include-in-header:
        - text: |
            <script>
            window.MathJax = {
            loader: {
                load: ['[tex]/physics']
            },
            tex: {
                packages: {'[+]': ['physics']}
            }
            };
            </script>
    slide-number: c/t
    transition: fade
    transition-speed: fast
    menu:
      side: left
# jupyter: python3
---
# Finite Differences

:::: {.columns}
::: {.column width="33%"}
![Explicit](pics/dtforward.svg)
:::
::: {.column width="33%"}
![Implicit](pics/dtbackward.svg)
:::
::: {.column width="33%"}
![Mixed](pics/dtmixed.svg)
:::
::::

## Recap Finite Differences

* elliptic (Poisson) or parabolic PDE problems
* replace partial differential operators $\partial$ by finite differences $\Delta$
* transfer PDE into a matrix-vector equation $\vb A \vb u = \vb b$
* finite-difference stencil spatial or temporal
* spatial derivative $\Rightarrow$ stiffness $\vb A$, temporal $\Rightarrow$ mass matrix $\vb M$
* time-stepping explicit, implicit or mixed (stable & accurate)
* accuracy depends on discretization, parameter contrast

## Time-stepping schemes

:::: {.columns}
::: {.column width="33%"}
![Explicit](pics/dtforward.svg)
:::
::: {.column width="33%"}
![Implicit](pics/dtbackward.svg)
:::
::: {.column width="33%"}
![Mixed](pics/dtmixed.svg)
:::
::::

# Stability of time-stepping

Consider Newton cooling problem

$$ \pdv{T}{t} = -\frac{T}{\tau} \approx \dv{T}{t} $$

with solution $$ T(t)=T_0 \exp(-t/\tau) $$

## Explicit Euler method

$$ T_{i+1} = T_i - \frac{dt}{\tau} T_i = T_i (1-\frac{dt}{\tau}) = T_0 (1-\frac{dt}{\tau})^{i+1} $$

$T_{i+1} < T_i$ requires $0\le 1-dt/\tau<1$

$$\Rightarrow 0 < dt \le \tau $$

::: {.callout-important}
Explicit method simple, but instable for $dt<\tau$
:::

## Implicit Euler method

$$ \frac{T_{i+1}-T_i}{dt} = -\frac{T_{i+1}}{\tau} $$

$$ T_{i+1} = T_i \frac{1}{1+dt/\tau} $$

$$ 0 \le \frac{1}{1+dt/\tau} < 1 $$

::: {.callout-caution}
unconditionally stable (but maybe still inaccurate)
:::

## Mixed (Crank-Nicholson) method

$$ \frac{T_{i+1}-T_i}{dt} = -\frac{T_{i+1}+T_i}{2\tau} $$

$$ T_{i+1} (1+dt/2\tau) = T_i (1-dt/2\tau) $$

$$ T_{i+1} = T_i \frac{1-dt/2\tau}{1+dt/2\tau} $$

::: {.callout-tip}
always stable and decreasing for $dt<2\tau$
:::

## Numerical comparison

```{python}
#| eval: true
#| echo: false

import numpy as np
import matplotlib.pyplot as plt

tau = 0.2
dt = 0.1
t = np.arange(0, 2.0, dt)
Ae = np.ones_like(t)
for i in range(1, len(t)):
    Ae[i] = Ae[i-1] * (1-dt/tau)
Ai = np.ones_like(t)
for i in range(1, len(t)):
    Ai[i] = Ai[i-1] / (1+dt/tau)
Am = np.ones_like(t)
for i in range(1, len(t)):
    Am[i] = Am[i-1] * (1-dt/tau/2) / (1+dt/tau/2)
plt.semilogy(t, np.exp(-t/tau), "-", label="analytic")
plt.plot(t, Ae, "x", label="explicit")
plt.plot(t, Ai, "+", label="implicit")
plt.plot(t, Am, "o", label="mixed")
plt.legend()
plt.grid()
```


# Other equation types

* [x] Poisson equation (elliptic)
* [x] diffusion equation (parabolic)
* [ ] wave equation (hyperbolic)
* [ ] Helmholtz equation (elliptic)

## Hyberbolic equations

Acoustic wave equation in 1D
$$ \pdv[2]{u}{t} - c^2\pdv[2]{u}{x} = 0 $$

$u$..pressure/velocity/displacement, $c$..velocity

Damped (mixed parabolic-hyperbolic) wave equation
$$ \pdv[2]{u}{t} - a\pdv{u}{t} - c^2\pdv[2]{u}{x} = 0 $$


## Discretization

:::: {.columns}
::: {.column}
$$ \pdv[2]{u}{t}^{n} \approx \frac{u^{n+1}-u^n}{\Delta t} - \frac{u^{n}-u^{n-1}}{\Delta t}
$$

$$ = \frac{u^{n+1}+u^{n-1}-2 u^n}{\Delta t^2} = c^2\pdv[2]{u}{x}^n $$


$$ u^{n+1} = c^2 \Delta t^2 \pdv[2]{u}{x}^{n} + 2 u^n - u^{n-1} $$

<!-- \frac{1}{\Delta t}  -->

$$ \vb u^{n+1} = (2\vb I - \vb A ) \vb u^n - \vb I \vb u^{n-1} $$
:::
::: {.column}

```{python}
#| eval: true
#| echo: false
import numpy as np
import pygimli as pg
grid = pg.createGrid(5, 5)
grid.translate([0, -2])
grid.scale([1, 0.7])
ax, cb = pg.show(grid)
ax.set_yticks([])
ax.set_xticks(np.arange(5))
ax.plot([1, 2, 3], [0, 0, 0], "bo-", ms=12, lw=4)
ax.plot([2, 2], [-0.7, 0.7], "g-", lw=4)
ax.plot(2, 0.7, "ro", ms=12);
ax.plot(2, -0.7, "go", ms=12);
ax.plot(2, 0, "go", ms=8);
```
:::
::::

<!--
![Second derivative](pics/dtsecond.svg)
 -->

## Example: velocity distribution

```{python}
#| output-location: column-fragment
#| eval: true
#| echo: true
x=np.arange(0, 600.01, 0.5)
c = 1.0*np.ones_like(x) # velocity in m/s
c[100:300] = 1 + np.arange(0,0.5,0.0025)
c[900:1100] = 0.5  # low velocity zone

# Plot velocity distribution.
plt.plot(x,c,'k')
plt.xlabel('x [m]')
plt.ylabel('c [m/s]')
plt.grid()
```


## Initial displacement

Derivative of Gaussian (Ricker wavelet)
```{python}
#| output-location: column-fragment
#| eval: true
#| echo: true
l=5.0

# Initial displacement field [m].
u=(x-300.0)*np.exp(-(x-300.0)**2/l**2)
# Plot initial displacement field.
plt.plot(x,u,'k')
plt.xlabel('x [m]')
plt.ylabel('u [m]')
plt.title('initial displacement field')
plt.show()
```

## Time propagation

```{python}
#| output-location: column-fragment
#| eval: true
#| echo: true
u_last=u
dt = 0.5
ddu = np.zeros_like(u)
dx = np.diff(x)
for i in range(100):
    dudx = np.diff(u)/dx
    ddu[1:-1] = np.diff(dudx)/dx[:-1]
    u_next = 2*u-u_last+ddu*c**2 * dt**2
    u_last = u
    u = u_next

plt.plot(x,u,'k')
```

## {background-video="notebooks/wave.mp4" background-video-loop="true"}

# Helmholtz equations

e.g. from Fourier assumption $u=u_0 e^{\imath\omega t}$

$$ -\div (a\grad u) + k^2 u = f $$

* Laplace operator assembled in FD system matrix $\vb A$
* additional terms with $u_i$ $\Rightarrow$ add "mass" to stiffness

$$ \Rightarrow (\vb A + k^2\vb I)\vb u = \vb b $$

## Wave equations in frequency domain

$$ \pdv[2]{u}{t} - c^2\pdv[2]{u}{x} = 0 $$

separation approach: $u(z, t)=e^{\imath\omega t} X(x)$

$$ \Rightarrow \pdv[2]{u}{t} = -\omega^2 e^{\imath\omega t} X(x) = -\omega^2 u $$

$$ \Rightarrow -\omega^2 u - c^2\pdv[2]{u}{x} = 0 \Rightarrow a \pdv[2]{X}{x} + \omega^2 X = 0 $$

## Heat transfer in frequency domain

separation approach: $T(z, t)=e^{\imath\omega t} Z(z)$

$$ \Rightarrow \pdv{T}{t} = \imath\omega e^{\imath\omega t} Z(z) = \imath\omega T $$

$$ \pdv{T}{t} - a\pdv[2]{T}{z} \Rightarrow - a\pdv[2]{T}{z} + \imath\omega T = 0 $$

$$ \Rightarrow - a e^{\imath\omega t}\pdv[2]{Z}{z} + \imath\omega e^{\imath\omega t} Z = 0 $$

## Heat transfer in frequency domain

separation approach: $T(z, t)=e^{\imath\omega t} Z(z)$

$$ \Rightarrow \pdv{T}{t} = \imath\omega e^{\imath\omega t} Z(z) = \imath\omega T $$

$$ \pdv{T}{t} - a\pdv[2]{T}{z} \Rightarrow - a\pdv[2]{T}{z} + \imath\omega T = 0 $$

$$ \Rightarrow - a \pdv[2]{Z}{z} + \imath\omega Z = 0 $$

## Maxwells equations

* Faraday's law: currents & varying electric fields $\Rightarrow$ magnetic field
$$ \curl \vb H = \pdv{\vb D}{t} + \vb j $$
* Ampere's law: time-varying magnetic fields induce electric field
$$ \curl\vb E = -\pdv{\vb B}{t}$$
* $\div\vb D = \varrho$ (charge $\Rightarrow$), $\div\vb B = 0$ (no magnetic charge)
* material laws $\vb D = \epsilon \vb E$ and $\vb B = \mu \vb H$ (now $\epsilon$/$\mu$ constant)

## Maxwell in frequency domain

$$\vb E = \vb E_0 e^{\imath\omega t} \qq{or} \vb H = \vb H_0 e^{\imath\omega t}$$

$$ \curl \vb H = \imath\omega\epsilon\vb E + \vb \sigma \vb E $$

$$ \curl\vb E = -\imath\omega\mu\vb H$$

## Helmholtz equation

see also [Theory EM](https://ruboerner.github.io/ThEM/mtfields.html)

take curl of one of the equations and insert in the other

$$ \curl\curl \vb E + \imath\omega\mu\sigma\vb E - \omega^2\mu\epsilon \vb E = \curl \vb j_s$$

$$ \curl \rho \curl \vb H + \imath\omega\mu\vb H - \omega^2\mu\epsilon\rho \vb H=0$$

## Quasi-static approximation

Assume: $\omega^2\mu\epsilon<\omega\mu\sigma$,  no sources ($\div\vb j_s=0$), + vector identity
$$\curl\curl \vb F = \grad \div \vb F - \grad^2 \vb F$$
leads with $\div \vb E=0=\div\vb B$ to the vector Helmholtz PDE

$$-\grad^2 \vb E + \imath\omega\mu\sigma \vb E=0$$

$$-\div \sigma^{-1} \grad H_{xyz} + \imath\omega\mu H_{xyz}=0$$

## Electromagnetic fields in the Earth

Maxwell equations lead to diffusion equation

$$\pdv[2]{\vb B}{z}=\mu_0\sigma\pdv{\vb B}{t}$$

A periodic excitation ($B_0 e^{\imath\omega t}$) leads to (cf. temperature diffusion)

$$B=B_0 e^{-z/d}\cos(\omega t-z/d)$$

with the skin depth $d=\sqrt{2/(\mu_0 \sigma\omega)}\approx 503\sqrt{\rho/f}$


# Equation solvers

$$\vb A \vb u = \vb b $$

$A$ represents PDE (incl. coefficients) and BC equations, $\vb b$ BC values

## Sparse matrices

Up to now: regular (dense) array: save every element including 0

**Sparse**: Save only non-zero components (e.g. using `scipy.sparse`)

* COO - coordinate format
* CSC/CRS - compressed sparse column/row
* BSR - block sparse row format, ...

## Solve systems of equations
**direct solvers**

* Gauss elimination (expensive and dense)
* Cholesky (or ILU) decomposition

**indirect solvers (fixed-point iteration)**

* gradient methods: steepest descent, conjugate gradients
* preconditioning: incomplete factorizations (of submatrices)

## Cholesky decomposition

$$\vb A = \vb L \vb L^T \qqtext{or} \vb A = \vb L \vb D \vb L^T $$

::: {.callout-tip title="Particularly important if many right-hand sides need to be computed"}
- many transmitters (flying helicopter)
- time-stepping (same matrix in every step)
- computation of Jacobian matrix (inversion)
:::

* do decomposition (generate sparse $\vb L$ matrix)
* back-substitution for every right-hand side

## Reordering

![original (left) & reordered (right) matrix (RÃ¼cker et al. 2006)](pics/reordering.png)

## Iterative solvers - fixed-point iteration

$$\vb A \vb x = \vb b$$
split $\vb A=\vb M - \vb N$ ($\vb M$ easily invertible) and solve
$$\vb M\vb x = \vb N \vb x + \vb b$$
iterativily by $\vb x^{k+1}=\vb M^{-1}\left(\vb N\vb x^k + \vb b\right)$

e.g. $\vb M=\mbox{diag}(\vb A)$ (Jacobi method) or<br>
$\vb M=\mbox{tril}(\vb A)$ (Gauss-Seidel method)

## Gradient methods

minimize residual $\vb r = \vb b - \vb A\vb x$

### Steepest descent method
$$\vb r_0 = \vb b - \vb A \vb x_0 $$

go towards $\vb r_0$ and minimize step length $\alpha$

$$\vb r_1^T\vb r_0 = 0 = \vb b - \vb A(\vb x_0+\alpha\vb r_0)$$

$$ \Rightarrow \alpha = \frac{\vb r_0^T\vb r_0}{\vb r_0\vb A \vb r_0} $$

## Steepest descent algorithm
`for i = 0,1, ...`
$$\vb r_i = \vb b - \vb A \vb x_i $$

$$ \Rightarrow \alpha_i = \frac{\vb r_i^T\vb r_i}{\vb r_i\vb A \vb r_i} $$

$$\vb x_{i+1} = \vb x_i + \alpha_i\vb r_i$$

## Conjugate directions

Set of orthogonalen directions $\vb d$ with

$$ \vb d^T_i \vb A \vb d_j = 0 \qquad \forall i\ne j $$

::: {.callout-note}
every search direction is only used once
:::

$$\vb x_{i+1} = \vb x_i + \alpha_i\vb d_i$$

## Conjugate directions

![](pics/conjugate_directions.png)

## Conjugate gradient (Hestenes&Stiefel, 1952)

$$\vb d_0 = \vb r_0 = \vb b - \vb A \vb x_0 $$
$$ \alpha_i = \frac{\vb r_i^T\vb r_i}{\vb d_i\vb A \vb d_i} $$
$$\vb x_{i+1} = \vb x_i + \alpha_i\vb d_i$$
$$\vb r_{i+1} = \vb r_i - \alpha_i\vb A \vb d_i$$
$$d_{i+1} = \vb r_{i+1} + \vb d_{i+1} \frac{\vb r_{i+1}^T\vb r_{i+1}}{\vb r_i^T\vb r_i}$$

## Steepest descent vs. conjugate gradient
::::{.columns}
:::{.column width="50%"}
![](pics/shewchukSD.png){fig-align="center"}
:::
:::{.column width="50%"}
![](pics/shewchukCG.png){fig-align="center"}
:::
::::

## Preconditioning

$\vb A \vb x=\vb b$ often badly conditioned (elongated) $\Rightarrow$ slow convergence

**Idea:** transform (precondition) equation system by preconditioner $\vb K$

$$\vb K^{-1} \vb A \vb x = \vb K^{-1}\vb b$$

Extreme cases: 1. $\vb K=\vb I$, cheap PC but no gain

2. $\vb K=\vb A$, perfect conditioning but expensive PC<br>
e.g. $\vb K=\mbox{diag} \vb A$ or $\vb K=\epsilon\mbox{tril} \vb A$

## Incomplete Cholesky decomposition
::::{.columns}
:::{.column width="50%"}
$$\vb A\approx \vb L \vb L^T$$

with certain accuracy or sparsity
:::
:::{.column width="50%"}
![](pics/preconditioners.png){fig-align="center"}
:::
::::

