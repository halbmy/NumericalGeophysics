---
title: "Numerical Simulation Methods in Geophysics, Part 5: Finite Elements"
subtitle: "1. MGPY+MGIN"
author: "thomas.guenther@geophysik.tu-freiberg.de"
title-slide-attributes:
  data-background-image: pics/tubaf-logo.png
  data-background-size: 20%
  data-background-position: 10% 95%
format:
  tubaf-revealjs:
    html-math-method: mathjax
    chalkboard: false
    include-in-header:
        - text: |
            <script>
            window.MathJax = {
            loader: {
                load: ['[tex]/physics']
            },
            tex: {
                packages: {'[+]': ['physics']}
            }
            };
            </script>
    slide-number: c/t
    transition: fade
    transition-speed: fast
    menu:
      side: left
# jupyter: python3
---

## Recap Finite Differences

* elliptic (Poisson) or parabolic PDE problems
* replace partial differential operators $\partial$ by finite differences $\Delta$
* transfer PDE into a matrix-vector equation $\vb A \vb u = \vb b$
* finite-difference stencil spatial or temporal
* spatial derivative $\Rightarrow$ system matrix $\vb A$, temporal $\Rightarrow$ identity matrix $\vb I$
* time-stepping explicit, implicit or mixed (stable & accurate)
* accuracy depends on discretization & parameter contrast

# The Finite Element Method

## History and background

* [1943] Courant: Variational Method
* [1956] Turner, Clough, Martin, Topp: Stiffness
* [1960] Clough: Finite Elements for static elasticity
* [1970-80] extension to structural, thermic and fluid dynamics
* [1990] computational improvements
* now main method for almost all PDE types

Geophysics: Poisson equation in 1970s, revival in 1990s and predominant from 2000s up to now

## Variational formulation of Poisson equation

$$ -\div a \grad u = f $$

::: {.fragment}
Multiplication with test function $w$ and integration $\Rightarrow$ weak form

$$ -\int_\Omega w \div a \grad u \dd\Omega = \int_\Omega w f \dd\Omega $$
:::

::: {.fragment}
$$ \div(b\vb c) = b\div \vb c + \grad b \cdot \vb c $$
:::

::: {.fragment}
$$ \int_\Omega a \grad w \cdot \grad u \dd\Omega - \int_\Omega \div(w a \grad u) \dd\Omega = \int_\Omega w f \dd\Omega $$
:::

## Variational formulation of Poisson equation

$$ \int_\Omega a \grad w \cdot \grad u \dd\Omega - \int_\Omega \div(w a \grad u) \dd\Omega = \int_\Omega w f \dd\Omega $$

::: {.fragment}
use Gauss' law $\int_\Omega \div \vb A = \int_\Gamma \vb A \cdot \vb n$

$$ \int_\Omega a \grad w \cdot \grad u \dd\Omega - \int_\Gamma a w \grad u \cdot \vb n \dd\Gamma = \int_\Omega fw \dd\Omega $$
:::

::: {.fragment}
Let $u$ be constructed by shape functions $v$: $u=\sum_i u_i v_i$

$$ \int_\Omega a \grad w \cdot \grad v_i \dd\Omega - \int_\Gamma a w \grad v_i \cdot \vb n \dd\Gamma = \int_\Omega fw \dd\Omega $$
:::

## Galerkin's method

$$ \int_\Omega a \grad w \vdot \grad v_i \dd\Omega - \int_\Gamma a w \grad v_i \cdot \vb n \dd\Gamma = \int_\Omega fw \dd\Omega $$

::: {.fragment}
Test functions the same as shape (trial) functions $w\in  v_i$

$$ \int_\Omega a \grad v_j \vdot \grad v_i \dd\Omega - \int_\Gamma a v_j \grad v_i \vdot \vb n \dd\Gamma = \int_\Omega f v_j \dd\Omega $$
:::

::: {.fragment}
* choose $v_i$ so that $\grad v_i$ is simple and $\grad v_i \vdot \grad v_j$ mostly 0
* divide subsurface in sub-volumes $\Omega_i$ with constant $a_i$ (& $\grad v_j$)
:::

# FE for 1D Poisson PDE
```{python}
#| eval: true
#| echo: false
import numpy as np
import matplotlib.pyplot as plt
x = np.array([0, 1., 2.1, 3.5, 5.0])
y = np.zeros_like(x)
y[2] = 1
fig, ax = plt.subplots()
ax.plot(x, y, "-")
ax.set_aspect(1.0)
ax.set_xticks(x)
ax.grid()
```
Every node carries a hat

## 1st-order nodal shape functions (hats)
```{python}
#| eval: true
#| echo: false
fig, ax = plt.subplots(figsize=(8, 4), nrows=2, sharex=True)
for i in range(len(x)):
    si = np.zeros_like(x)
    si[i] = 1
    ax[0].plot(x, si)
    dsdx = np.diff(si)/np.diff(x)
    ax[1].stairs(dsdx, x, ls="--", zorder=10, label=f"i={i}")

ax[0].set_xticks(x)
ax[0].set_yticks([0, 1])
ax[1].set_yticks([-1, 0, 1])
ax[0].grid()
ax[1].grid()
ax[1].legend()
ax[1].set_xlabel("x")
ax[0].set_ylabel(r"$v_i$(x)")
ax[1].set_ylabel(r"$\partial v_i/\partial x$");
fig.tight_layout()
```

<!--
## Hat functions

![](pics/shapefunctions1d.svg){width="100%"}
 -->

## Gradients for hat functions
* every element is surrounded by two nodes "carrying" a hat.
* the gradients $v'_i$ are piece-wise constant $\pm 1/\Delta x_i$
* neighboring functions $v_i$ & $v_{i+1}$ only meet between $x_i$ & $x_{i+1}$

$$ \int_\Omega a \grad v_i \vdot \grad v_{i+1} \dd\Omega = \int_{x_i}^{x_{i+1}} a_i v'_i v'_{i+1} \dd\Omega = -\frac{a_i}{\Delta x_i^2} \Delta x_i = -\frac{a_i}{\Delta x_i}$$

$$ \int_{x_{i-1}}^{x_{i+1}} a v'_i v'_i \dd\Omega = \frac{a_{i-1}}{\Delta x_{i-1}^2}\Delta x_{i-1} + \frac{a_i}{\Delta x_i^2}\Delta x_i = \frac{a_{i-1}}{\Delta x_{i-1}} + \frac{a_i}{\Delta x_i} $$

<!-- $$ -\int_\Omega a \grad v_i \vdot \grad v_{i+2} \dd\Omega = 0 $$ -->

## Integration

Let's write the equation for the first and second nodes in 1D

$$ \int_{x_0}^{x_1} u_0 a_0 v_0' v_0' + \int_{x_0}^{x_1} u_1 a_1 v_0' v_1' = \int_{x_0}^{x_1} v_0 f $$

$$ \int_{x_0}^{x_1} u_0 a v_0' v_1' + \int_{x_0}^{x_2} u_1 a v_1' v_1' + \int_{x_1}^{x_1} a u_2 v_2' v_1' = \int_{x_0}^{x_2} v_1 f $$

<!-- $$ \int u_1 v_1' v_2' + \int u_2 v_2' v_2' + \int u_3 v_3' v_2' = \int v_1 f $$ -->

$$ u_{i-1} a_{i-1} \int\limits_{x_{i-1}}^{x_{i}} v_i' v_{i-1}' +
   u_i a_{i-1} \int\limits_{x_{i-1}}^{x_{i}} v_i' v_i' +
   u_i a_i \int\limits_{x_{i}}^{x_{i+1}} v_i' v_i' +
   u_{i+1} a_{i} \int\limits_{x_{i}}^{x_{i+1}} v_i' v_{i+1}' $$


# The stiffness matrix

Matrix integrating gradients of base functions for neighbors with $a$

$$ \vb A_{i, i+1} = -\frac{a_i}{\Delta x_i^2} \vdot \Delta x_i = -\frac{a_i}{\Delta x_i} $$

$$ A_{i,i} = \int_\Omega a \grad v_i \cdot \grad v_i \dd\Omega = -A_{i,i+1} - A_{i+1,i}  $$

$\Rightarrow$ matrix-vector equation $\vb A \vb u = \vb b$ with bending&shear stiffness in $\vb A$
<!-- $\Rightarrow$ -->

## Boundary conditions

second term
$$ - \int_\Gamma a v_j \grad v_i \cdot \vb n \dd\Gamma $$

reads in 1D as

$$ [a v_i v_j']_{x_0}^{x_N} = a_{N-1} u_N v_N' - a_0 u_0 v_0' $$

$\Rightarrow$ Homogeneous Neumann BC ($v'_0=0$) are automatically implemented

## Right-hand side vector

The right-hand-side vector $b=\int v_i f \dd\Omega$ also scales with $\Delta x$

e.g. $f=\div \vb j_s$ $\Rightarrow$
$b=\int v_i \div \vb j_s \dd\Omega = \int_\Gamma v_i \vb j_S \cdot \vb n$

(system identical to FD for $\Delta x$=1)

:::{.callout-tip icon="false" title="Difference of FE to FD"}
Any source function $f(x)$ can be integrated on the whole space!
:::

## Solution

$\vb u$ holds the coefficient $u_i$ creating $u(x)=\sum u_i v_i(x)$

:::{.callout-tip icon="false" title="Difference of FE to FD"}
$u$ is described on the whole space and approximates the solution, not the PDE!
:::

Hat functions: $u_i$ potentials on nodes, $u$ piece-wise linear

:::{.callout-tip icon="false" title="Generality of FE"}
Arbitrary base functions $v_i$ can be used to describe $u$
:::

## Method of weighted residuals

PDE $\mathfrak{L}(u)=f$ $\Rightarrow$ approximated by $u_h$

residual $R=L_h(u)-f$ to be minimized, integrating over modelling domain

$$ \int_\Omega w R \dd\Omega = \int_\Omega w \mathfrak{L}(u_h)\dd\Omega - \int_\Omega w f \dd\Omega = 0 $$

with approximation $u_h(\vb r)=\sum_j^M u_j \vb v_j(\vb r)$

($\vb v$ basis / shape functions, $\vb w$ test / trial functions)

## Bilinear form for Poisson equation

Solve $\vb A \vb x = \vb b$ with $A_{ij}=(\grad v_i, a \grad v_j)$ and $b_i=(\vb v_i, f)$, where

$$(\vb a, \vb b)=\int_\Omega \vb a \cdot \vb b\,\dd\Omega = \sum\limits_{c=i}^M \int_{\Omega_c} \vb a \cdot \vb b\,\dd\Omega_c$$

Solve the integrals either analytically or numerically

## Coordinate transformation

1D: local coordinate $\xi=\frac{x-x_i}{x_{i+1}-x_i}$ (0..1)

$u(\xi)=c_1+c_2\xi$

$u_0=u(0)=c_1$, $u_1=u(1)=c_1+c_2$  $\Rightarrow c_2=u_1-u_0$

$$\Rightarrow u(\xi)=u_0+\xi(u_1-u_0)=u_0(1-\xi)+u_1\xi=u_0 v_0 + u_1 v_1$$

## Quadratic elements
$u(\xi)=c_1+c_2\xi+c_3\xi^2$

nodes at $x_0$, $x_{1/2}$, $x_1$

$u_i=u(0)=c_1$, $u_1=c_1+c_2+c_3$

$u_{1/2}=c_1+c_2/2+c_3/4$

$$u(\xi)=u_0(1-3\xi+2\xi^2)+u_{1/2}(4\xi-4\xi^2)+u_1(-\xi+2\xi^2)$$


## Quadratic elements

$$u(\xi)=u_0(3\xi+2\xi^2)+u_{1/2}(4\xi-4\xi^2)+u_1(-\xi+2\xi^2)$$

```{python}
#| output-location: column
#| eval: true
#| echo: true
import numpy as np
import matplotlib.pyplot as plt
x=np.linspace(0, 1, 101)

# Plot velocity distribution.
plt.plot(x, 1-3*x+2*x**2)
plt.plot(x, 4*x-4*x**2)
plt.plot(x, -x+2*x**2)
plt.plot(0, 0, "o", color="C0", ms=8)
plt.plot(0.5, 0, "o", color="C1", ms=8)
plt.plot(1, 0, "o", color="C2", ms=8)
plt.grid()
```

## Cubic elements

<!-- $$u(\xi)=u_0(3\xi+2\xi^2)+u_{1/2}(4\xi-4\xi^2)+u_1(-\xi+2\xi^2)$$ -->

```{python}
#| output-location: column
#| eval: true
#| echo: true
import numpy as np
import matplotlib.pyplot as plt
x=np.linspace(0, 1, 101)

# Plot velocity distribution.
plt.plot(x, 1-5.5*x+9*x**2-4.5*x**3)
plt.plot(x, 9*x-22.5*x**2+13.5*x**3)
plt.plot(x, -4.5*x+18*x**2-13.5*x**3)
plt.plot(x, x-4.5*x**2+4.5*x**3)
for i in range(4):
    plt.plot(i/(3), 0, "o",
             color=f"C{i}", ms=8)
plt.grid()
```

## Triangles with linear shape functions

:::: {.columns}
::: {.column width="60%"}

$$x=x_1+(x_2-x_1)\xi+(x_3-x_1)\eta$$
$$y=y_1+(y_2-y_1)\xi+(y_3-y_1)\eta$$
:::
::: {.column width="40%"}

```{python}
#| eval: true
#| echo: false
plt.fill_betweenx([1, 0], [0, 1])
plt.text(0.05, 0.05, "P1")
plt.text(1, 0.05, "P2")
plt.text(0.05, 1, "P3")
plt.xlabel(r"$\xi$")
plt.ylabel(r"$\eta$");
```
:::
::::

## Triangle

$$u(\xi)=u_1(1-\xi-\eta)+u_2\xi+u_3\eta$$

```{python}
#| output-location: column
#| eval: true
#| echo: true
import pygimli as pg
import pygimli.meshtools as mt

shape = mt.createPolygon(
    [[0, 0], [1, 0],[0, 1]],
    isClosed=True)
mesh = mt.createMesh(shape, area=0.01)
mx = pg.x(mesh)
my = pg.y(mesh)
# Plot velocity distribution.
fig, ax = plt.subplots()
pg.show(mesh, 1-mx-my, ax=ax,
        nLevs=11, label="u");
```

## Triangle linear shape functions

$$u(\xi)=u_1(1-\xi-\eta)+u_2\xi+u_3\eta$$

```{python}
#| eval: true
#| echo: false
fig, ax = plt.subplots(figsize=(12, 6), ncols=3, sharex=True, sharey=True)
fig.tight_layout()
pg.show(mesh, 1-mx-my, ax=ax[0], nLevs=11);
pg.show(mesh, mx, ax=ax[1], nLevs=11);
pg.show(mesh, my, ax=ax[2], nLevs=11);
```

## The general solution

Solving any integral using (Gaussian) quadrature
$$\int g(x) \dd x \approx \sum_q g(x_q) w_q$$

$$f_i^c=\int_{\Omega_c} v_i f \dd x \approx \sum_q v(x_q^c)f(x_q^c)w_q^c$$

$$a_{ij}^c = \int_c a_c \grad v_i \cdot \grad v_j=\sum a_c \grad v_i(x_q^c)\cdot \grad v_j(x_q^c) w_q^c $$

## Gaussian quadrature

:::: {.columns}
::: {.column width="45%"}
![Quadrature points](pics/triangle_quadrature.svg){width="100%"}
:::
::: {.column width="55%"}
`quadratureRules(c.shape(), 5)`

* optimum quadrature on reference triangle for a given order (5)
:::
::::

## Gaussian quadrature

:::: {.columns}
::: {.column width="45%"}
![Quadrature points](pics/oscar_quadrature_triangle.svg){width="100%"}
:::
::: {.column width="55%"}
`quadratureRules(c, 2)`

* optimum quadrature on arbitrary triangle for order 2
:::
::::

## Verification

1. Method of Manufactured Solutions (MMS)
  * manufacture a smooth u
  * generate $f$ matching approximation of $u$
2. Method of Exact Solutions (MES)
  * find parameters for which an analytic solution exists
3. Perform convergence tests for increasingly smaller $h$
  * approximation error $E(h)\lt C h^n$ test for some $h$

## Green's functions

The Green's function $G$ is the solution for a Dirac source $\delta$
$$ \mathfrak{L} G = \delta(\vb r) $$
The solution can then be obtained by convolution
$$ u(\vb r) = G(\vb r-\vb r')*f(\vb r') = $$


# Time-stepping in FE

## Recap time-stepping in FD

| | | | | | |
|-------------|-------------:|-|-|-:|-|
|**Explicit**:||$\vb u^{n+1}$|$=$|$(\vb I - \Delta t \vb A)$|$\vb u^n$|
|**Implicit**:|$(\vb I + \Delta t \vb A)$|$\vb u^{n+1}$|$=$||$\vb u^n$|
|**Mixed**:|$(2\vb I + \Delta t \vb A)$|$\vb u^{n+1}$|$=$|$(2\vb I - \Delta t \vb A)$|$\vb u^n$|

:::: {.columns}
::: {.column width="33%"}
![Explicit](pics/dtforward.svg)
:::
::: {.column width="33%"}
![Implicit](pics/dtbackward.svg)
:::
::: {.column width="33%"}
![Mixed](pics/dtmixed.svg)
:::
::::

## Variational formulation of Diffusion equation

$$ \pdv{u}{t} - \div a \grad u = f $$

Finite Difference in Time (NOT in space)

$$ \frac{u^{n+1}-u^n}{\Delta t} - \div a \grad u = f $$

## Variational formulation
$$ \frac{u^{n+1}-u^n}{\Delta t} - \div a \grad u = f $$

::: {.fragment}
Multiplication with test function $w$ and integration $\Rightarrow$ weak form

$$ 1/\Delta t (\int_\Omega w u^{n+1}\dd\Omega-\int_\Omega w u^{n}\dd\Omega) - \int_\Omega w \div a \grad u \dd\Omega = \int_\Omega w f \dd\Omega $$
:::

::: {.fragment}
$$ 1/\Delta t (\int_\Omega w u^{n+1}\dd\Omega-\int_\Omega w u^{n}\dd\Omega) - \int_\Omega a \grad w \cdot \grad u \dd\Omega = \int_\Omega w f \dd\Omega $$
:::

## Variational formulation of diffusion equation

$u$ is constructed of shape functions $\vb v_i$ that are identical to $w$

The integral over the Poisson term
$$-\int_\Omega a \grad w \cdot \grad u \dd\Omega$$

is represented by $\vb A \vb v$ using the stiffness matrix

$$ \vb A_{i,j} = \int_\Omega \sigma \grad v_i \cdot \grad v_j \dd\Omega $$

## Variational formulation of diffusion equation

Weighted integrals over both $u$ are represented by the mass matrix $\vb M \vb v$
$$ \vb M_{i,j} = \int_\Omega v_i \cdot v_j \dd\Omega $$

explicit method (use $u^n$): $\vb M \vb u^{n+1} = (\vb M - \Delta t \vb A)\vb u^n$

implicit method (use $u^{n+1}$): $(\vb M + \Delta t \vb A) \vb u^{n+1} = \vb M \vb u^n$

mixed method (mix $u^n$/$u^{n+1}$): $(2\vb M + \Delta t \vb A) \vb u^{n+1} = (2\vb M - \Delta t \vb A) \vb u^n$

## Time-stepping in FE

| | | | | | |
|-------------|-------------:|-|-|-:|-|
|**Explicit**:|$\vb M$|$\vb u^{n+1}$|$=$|$(\vb M - \Delta t \vb A)$|$\vb u^n$|
|**Implicit**:|$(\vb M + \Delta t \vb A)$|$\vb u^{n+1}$|$=$|$\vb M$|$\vb u^n$|
|**Mixed**:|$(2\vb M + \Delta t \vb A)$|$\vb u^{n+1}$|$=$|$(2\vb M - \Delta t \vb A)$|$\vb u^n$|

::: {.callout-tip}
same as in FD but with FE mass matrix $\vb M$ instead of $\vb I$
:::

## The mass matrix in 1D

$$ \vb M_{i,j} = \int_\Omega v_i \cdot v_j \dd\Omega $$

$$ \vb M_{i,i+1} = \int_{x_i}^{x_{i+1}}
\frac{x_{i+1}-x}{\Delta x_i} \frac{x-x_i}{\Delta x_i} \dd x
= \int_0^1 (1-\xi)\xi \Delta x_i \dd\xi $$

$$ \Rightarrow \vb M_{i,i+1} = \Delta x_i \int_0^1 (\xi-\xi^2) =
\Delta x_i \left|\frac12 \xi^2 - \frac13 \xi^3\right|_0^1 = \frac{\Delta x_i}{6} $$

## The mass matrix in 1D

$$ \vb M_{i,i} = \Delta x_{i-1} \int_0^1 \xi^2 \dd\xi + \Delta x_i \int_0^1 (1-\xi)^2 \dd\xi $$

$$ \vb M_{i,i} = \Delta x_{i-1} \left|\frac13 \xi^3 \right|_0^1 -
\Delta x_i \left|\frac13 \xi^3 \right|_1^0 $$

$$ \Rightarrow \vb M_{i,i} = \frac{\Delta x_{i-1}}{3} + \frac{\Delta x_i}{3} = 2(\vb M_{i,i-1}+\vb M_{i,i+1}) $$

$\Delta x=1 \quad\Rightarrow\quad [1, 4, 1]$ (stiffness was [-1, 2, -1])

## Inner vs. outer nodes

distinguish dofs into inner and outer $\mqty[\vb u_i, \vb u_o]^T$

$$ \vb A = \mqty(\vb A_{ii} & \vb A_{io}\\
                 \vb A_{oi} & \vb A_{oo}) $$

$\vb A \mqty[\vb u_i \\ \vb u_o] = \mqty[\vb f_i \\ \vb f_o]$

$$ \Rightarrow \vb A_{ii} \vb u_i = \vb f_i - \vb A_{oi} \vb u_o $$

## Tasks

1. Write a function computing the FE stiffness matrix for 1D discretization
1. Test it by solving the Poisson equation with $f=1$ (analytical solution)
1. Compare with analytical and FD solutions
1. Write a function computing the FE mass matrix for 1D discretization
1. Repeat the time-stepping tasks from FD with FE
