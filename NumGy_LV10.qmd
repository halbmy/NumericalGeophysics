---
title: "Numerical Simulation Methods in Geophysics, Lecture 10:<br/>2D/3D EM modelling"
subtitle: "1. MGPY+MGIN"
author: "thomas.guenther@geophysik.tu-freiberg.de"
title-slide-attributes:
  data-background-image: pics/tubaf-logo.png
  data-background-size: 20%
  data-background-position: 10% 95%
format:
  tubaf-revealjs:
    html-math-method: mathjax
    # chalkboard: true
    include-in-header:
        - text: |
            <script>
            window.MathJax = {
            loader: {
                load: ['[tex]/physics']
            },
            tex: {
                packages: {'[+]': ['physics']}
            }
            };
            </script>
    slide-number: c/t
    transition: fade
    transition-speed: fast
    menu:
      side: left
jupyter: python3
---
# Recap

* Maxwells equations (inductive) in time- and frequency domain
* single frequency approach (decomposition) so far 1D
* Helmholtz term ($\pdv[2]{u}{x}$ and $u$ term)
* $u$ term needs mass matrix (like in time-stepping)
* complex-valued problem: complex or double real matrix
* secondary field approach: $\sigma$ anomalies as sources

remaining dates: 22.1. (L11), 29.1. (L12), 5.2. (L13 online), 12.2. (TAP)

## Analytical solution
```{python}
#| echo: false
#| eval: true
import numpy as np
import matplotlib.pyplot as plt

T = 0.1
w = 2 * np.pi / T
sigma0 = 1/100  # 1/100
mu = np.pi * 4e-7
k = np.sqrt(-1j*w*mu*sigma0)
z = np.arange(-10000, 00000.1, 200)
skindepth = np.sqrt(2/w/sigma0/mu)
uAna = np.exp(1j*k*z)
fig, ax = plt.subplots(ncols=4, sharey=True)
ax[0].plot(uAna.real, -z/1000)
ax[1].plot(uAna.imag, -z/1000)
ax[2].plot(np.abs(uAna), -z/1000)
phi = np.rad2deg(np.unwrap(np.angle(uAna)))
ax[3].plot(phi, -z/1000)
ax[0].set_ylabel("z (km)")
ax[0].invert_yaxis()
tits = ['Real', 'Imag', 'Abs', 'Phase']
for a, t in zip(ax, tits):
  a.set_title(t)
  a.hlines(skindepth/1000, *a.get_xlim(), ls="--", color="C1")
  a.grid()
```


## Complex-to-real in pyGIMLi

$$\vb B = \mqty(\vb A & -\omega \vb M\\ \omega \vb M & \vb A)$$

```{python}
#| echo: false
#| eval: true
import pygimli as pg
import pygimli.meshtools as mt
import pygimli.solver as ps
world = mt.createWorld(start=[-10000, -10000], end=[10000, 0])
anomaly = mt.createRectangle(start=[0, -8000], end=[1000, -1000], marker=2)
mesh = mt.createMesh(world+anomaly, quality=34, smooth=True, area=1e5)
mesh["my"] = 4 * np.pi * 1e-7
mesh["sigma"] = sigma0
```

```{python}
#| echo: true
#| eval: true
#| output-location: column
A = ps.createStiffnessMatrix(mesh)
b = np.zeros(mesh.nodeCount())
ps.assembleBC({'Dirichlet': {-1: 1.0}},
              mesh, A,  b);
M = ps.createMassMatrix(
    mesh, mesh["sigma"]*mesh["my"])
nd = mesh.nodeCount()
B = pg.BlockMatrix()
B.Aid = B.addMatrix(A)
B.Mid = B.addMatrix(M)
B.addMatrixEntry(B.Aid, 0, 0)
B.addMatrixEntry(B.Aid, nd, nd)
B.addMatrixEntry(B.Mid, 0, nd, scale=-w)
B.addMatrixEntry(B.Mid, nd, 0, scale=w)
pg.show(B)
```

## Complex in pyGIMLi

```{python}
#| echo: true
#| eval: true
C = pg.matrix.CSparseMatrix(A.vecColPtr(), A.vecRowIdx(),
    pg.core.toComplex(A.vecVals(), M.vecVals()*w))
c = pg.core.toComplex(b, b*0)
u = ps.linSolve(C, c).array()  # important (bug in pyGIMLi!)
```

![](pics/helmholtz1D.svg)

## Secondary field for EM
Let $E_0$ be the solution to the equation for $\sigma=\sigma_0$
$$-\grad^2 E_0 +\imath\omega\mu\sigma_0 E_0=0$$

and $E=E_0+E_a$ for $\sigma=\sigma_0+\delta\sigma$

$$-\grad^2 (E_0 + E_a) +\imath\omega\mu(\sigma_0+\delta\sigma) (E_0+E_a)=0$$
subtracting leads to
$$-\grad^2 E_a +\imath\omega\mu(\sigma_0+\delta\sigma) E_a=-\imath\omega\mu\delta\sigma E_0$$


## Secondary field for EM

$$ -\grad^2 E_a + \imath\omega\mu\sigma E_a = -\imath\omega\mu\delta\sigma E_0 $$

::: {.callout-note}
Source terms only arise at anomalous conductivities and increase with primary field
:::

is solved for $E_0$($\vb u$) using $\vb A$-stiffness, $\vb M$-mass and $E_0$($\vb u_0$)

$$ (\vb A + \imath\omega\vb M_\sigma) \vb u = -\imath\omega\vb M_{\delta\sigma} \vb u_0 $$

```{python}
#| echo: true
#| eval: false
A = stiffnessMatrix1DFE(x=z)
M = massMatrix1DFE(x=z, a=w*mu*sigma)
dM = massMatrix1DFE(x=z, a=w*mu*(sigma-sigma0))
u = uAna + solve(A+M*w*1j, dM@uAna * w*1j)
```

## 2D scalar EM - TM polarization

$$ \curl \sigma^{-1} \curl \vb H + \imath\omega\mu\vb H=\curl\sigma^{-1} \vb j_s$$


::: {.callout-note title="Transverse magnetic (TM) mode"}
Assume the source field is oscillating perpendicular to the modelling plane, i.e.

$\vb H=[H_x, 0, 0]^T e^{\imath\omega t}$.
:::

Then the PDE holds for the scalar $H_x$

$$-\div \sigma^{-1} \grad H_x(y,z) + \imath\omega\mu H_x(y,z) = 0$$

## 2D scalar EM - TE polarization

$$ \curl \mu^{-1}\curl \vb E + \imath\omega\sigma\vb E = \curl \vb j_s$$

::: {.callout-note title="Transverse electric (TE) mode"}
Assume the source field is oscillating perpendicular to the modelling plane, i.e.

$\vb E=[E_x, 0, 0]^T e^{\imath\omega t}$.
:::

Then the PDE holds for the scalar $E_x$

$$-\div \mu^{-1} \grad E_x(y,z) + \imath\omega\sigma E_x(y,z) = 0$$

# EM vector modelling

$$ \curl \mu^{-1}\curl \vb E + \imath\omega\sigma\vb E - \omega^2\epsilon \vb E = -\imath\omega \vb j_s$$

$$ \curl \sigma^{-1} \curl \vb H + \imath\omega\mu\vb H - \omega^2\mu\epsilon \vb H = \curl \sigma^{-1}\vb j_s$$


## History

::: {.callout-note title="James Clerk Maxwell, Treatise on Electricity & Magnetism, 1891"}
“Physical vector quantities may be divided into two classes, in one of which
the quantity is defined with reference to a line, while in the other the quantity
is defined with reference to an area.”
:::
* integral equations (IE), finite differences (FD) and elements (FE)
* nodal and vector basis functions, secondary field
* decompose 3D source (2D inverse) in wavenumber domain
* improvement of equation solvers and preconditioners
* parallel solvers, high-performance computing

## Solving EM problems with staggered grid
![Staggered grid cell after Yee (1966) (Börner, 2010)](pics/yeeCellRedBlue.png){fig-align="center"}

## Solving EM problems with staggered grid
![Electric field components from one row of curl-curl (Börner, 2010)](pics/yeeCellRowE.png){fig-align="center"}

## The way from FD to FE

![Orthogonal, non-orthogonal and irregular grids (Rücker et al., 2006)](pics/rueckerGrids.png)

## The weak formulation

$$ \int_\Omega \vb w \curl \mu^{-1}\curl \vb E \dd\Omega - \imath\omega\int\vb w \sigma \vb E \dd\Omega = 0 $$

Integration, Greens identity $\int a\laplacian b = -\int \grad a \vdot \grad b - \int a\pdv*{b}{n}$

$$ \int_\Omega \vb w \ldots = \int_\Omega \curl \vb w \vdot (\mu^{-1}\curl \vb E) \dd\Omega + \int \vb n \cross (\mu^{-1}\curl \vb E) \dd \Gamma $$

choose basis that latter term vanishes

$$ \int_\Omega \curl \vb w \vdot (\mu^{-1}\curl \vb E) \dd\Omega  - \imath\omega\int\vb w \sigma \vb E \dd\Omega = 0 $$

## Galerkins method

$$ \vb E = \sum_i u_i \vb u \qqtext{with} \vb w \in \vb u_i $$

$$ \braket{\curl \vb w}{\mu^{-1}\curl\vb u_i} $$

$$ \vb A\vb u =\vb b \qqtext{with} A_{i,j} = \int_\Omega (\curl u_i)\vdot(\mu^{-1}\curl u_j) \dd\Omega $$

## The Finite Element zoo (1D & 2D)

::: {.columns}
::: {.column width="75%"}
![Arnold (2013): Periodic table of elements](pics/element_zoo1d2d.png){fig-align="center"}
:::
::: {.column width="25%"}
* $k$=0 Nodal elements
* $k$=1 edge elements
* $k$=2 face elements (Discontinuous Galerkin)
* $r$/$p$ higher order
:::
::::

## The Finite Element zoo (3D)

![Arnold (2013): [Periodic table of elements](https://www-users.cse.umn.edu/~arnold/femtable/)](pics/element_zoo3d.png){fig-align="center"}

## Vectorial solution for EM fields

:::: {.columns}
::: {.column}
![Schwarzbach & Haber (2013)](pics/schwarzbachHaber2013.png)
:::
::: {.column}
* $\vb E \in H^\text{curl}(\Omega)$
* $\vb B \in H^\text{div}(\Omega)$
* natural BC: Dirichlet $\vb n \cross \vb E=0$
* Neumann BC: $\vb n \cross \mu^{-1} \curl \vb E=0$
:::
::::

## Elements used in EM modelling
![Types of elements relevant for EM problems (Spitzer, 2024)](pics/EMelements.png)

## Nedelec shape functions

![](pics/curl/curl-element-shapefunctions.png)

## Modelling topography

![Modelling incorporating topography (Rochlitz, 2019)](pics/custem/topomodeling.png)

## Meshing complicated geometries

![Meshing workflow in custEM (Rochlitz et al., 2019)](pics/custem/meshes.png)

## Modelling example

![Modelling example of a conductive dike (Rochlitz et al., 2019)](pics/custem/examples.png)

## Packages

Mesh generation: [TetGen](https://tetgen.org) (3D), [GMsh](https://gmsh.info) (2D/3D)

FE packages: [FEniCS](https://fenicsproject.org), [NETGEN/NGsolve](https://ngsolve.org)

Equation solvers: [Suitesparse](https://doc.sagemath.org/html/en/reference/spkg/suitesparse.html), [MUMPS](https://mumps-solver.org), [SciPy](https://scipy.org)

Computational frameworks: [PetSc](https://petsc.org), [MPI](https://www.mcs.anl.gov/research/projects/mpi/)

EM modelling (and inversion) packages: [Mare2DEM](https://mare2dem.bitbucket.io), [emg3d](https://emg3d.emsig.xyz), GoFEM, [PETGEM](https://petgem.bsc.es/), [custEM](https://custem.readthedocs.io), [SimPEG](https://simpeg.xyz), ModEM, FEMTIC

# Boundary conditions

## Mixed boundary conditions
So far...

* Dirichlet Boundary conditions $u=u_0$
* Neumann Boundary conditions $\pdv{u}{n}=g_B$<br>

vectorial problems: $\vb n\cdot \vb E=0$ (Neumann) or $\vb\curl \vb E=0$ (Dirichlet)

In general mixed, also called Robin (or impedance convective) BC
$$ a u + b \pdv{u}{n} = c $$

## Example DC resistivity with point source
$$\div \sigma \grad u = \div \vb j = I \delta(\vb r - \vb r_s)$$

solution for homogeneous $\sigma$ on surface: $u=\frac{I}{2\pi\sigma} \frac{1}{|\vb r - \vb r_s|}$

E-field $\vb E=-\frac{I}{2\pi\sigma} \frac{\vb r - \vb r_s}{|\vb r - \vb r_s|^3}$

normal direction $\vb E \cdot \vb n=-\frac{u}{|\vb r - \vb r_s|}\cos \phi$ purely geometric

$$\pdv{u}{n} + \frac{\cos\phi}{|\vb r - \vb r_s|}=0$$

## Perfectly matched layers

::: {.columns}
::: {.column}
![](pics/FDTD_TFSF.png)
:::
::: {.column}
$$ \pdv{x} \rightarrow \frac{1}{1+i\sigma/\omega} \pdv{x}  $$

$$ x \rightarrow x + \frac{i}{\omega}\int^x \sigma(x')\dd x' $$

:::
:::


## Absorbing boundary conditions
wave equation (e.g. in 2D)
$$ \pdv[2]{u}{t} - v^2 \laplacian u = 0 $$

Fourier transform in $t$ and $y$ (boundary direction) $\Rightarrow \omega, k$

$$ \omega^2 \hat{u} - v^2 \pdv[2]{\hat{u}}{x} + v^2 k^2 \hat{u} = 0 $$

ordinary DE with solution $\hat{u}=\sum a_i e^{\lambda x}$ with $\lambda^2 = k^2 - \omega^2/v^2$

# Time-domain EM

* Fourier transform excitation $\Rightarrow$ solve in FD $\Rightarrow$ backtransform
* solve with Time-Stepping: Governing equation

$$ \curl\mu^{-1}\curl \vb e + \sigma \pdv{\vb e}{t} = -\pdv{\vb e_s}{t} $$

$$ \vb K \vb u + \vb M \pdv{u}{t} = \vb s $$

## Implicit time stepping

$$ (\Delta t \vb K + \vb M) \vb u^{n+1} = \vb M u^n +\Delta t \vb s^{n+1} $$

second-order
$$ (2\Delta t \vb K + 3 \vb M) \vb u^{n+2} = \vb M (4 \vb u^{n+1} - \vb u^n) - 2\Delta t \vb s^{n+2} $$

