---
title: "Numerical Simulation Methods in Geophysics, Lecture 11:<br/>3D EM modelling"
subtitle: "1. MGPY+MGIN"
author: "thomas.guenther@geophysik.tu-freiberg.de"
title-slide-attributes:
  data-background-image: pics/tubaf-logo.png
  data-background-size: 20%
  data-background-position: 10% 95%
format:
  tubaf-revealjs:
    html-math-method: mathjax
    # chalkboard: true
    include-in-header:
        - text: |
            <script>
            window.MathJax = {
            loader: {
                load: ['[tex]/physics']
            },
            tex: {
                packages: {'[+]': ['physics']}
            }
            };
            </script>
    slide-number: c/t
    transition: fade
    transition-speed: fast
    menu:
      side: left
jupyter: python3
---
# Recap

* Maxwells equations (inductive) in time- and frequency domain
* FD: $u$ term needs mass matrix (like in time-stepping)
* from staggered grids (curl) to curl-conforming Nédélec elements
* today: finish modern FE methods for Maxwell, HPC

remaining: 29.1. (FV+advection), 5./6.2. (summary, online), 12.2. (TAP)

## Governing equations

$$ \curl \sigma^{-1} \curl \vb H + \imath\omega\mu\vb H=\curl\sigma^{-1} \vb j_s$$

$$ \curl \mu^{-1}\curl \vb E + \imath\omega\sigma\vb E = -\imath\omega \vb j_s$$

* air ($\sigma$ small): $H$ linear (or constant)

#### TE and TM polarizations: scalar problems

$$-\div \sigma^{-1} \grad H_x(y,z) + \imath\omega\mu H_x(y,z) = 0$$

$$-\div \mu^{-1} \grad E_x(y,z) + \imath\omega\sigma E_x(y,z) = 0$$

## Original source for Nédélec

![](pics/curl/nedelec_paper.png)

Designed for streaming problems ($p$-pressure, $\vb u$-velocity)

$$ -v\laplacian \vb u + \grad p = \vb f \qquad \div \vb u=0 $$

Approach: $\vb w=\curl\vb u=-\laplacian \vb \phi$ $\Rightarrow$ $\vb u=\curl\vb\phi\qquad \div\vb \phi=0$

# EM vector modelling

$$ \curl \mu^{-1}\curl \vb E + \imath\omega\sigma\vb E - \omega^2\epsilon \vb E = -\imath\omega \vb j_s$$

$$ \curl \sigma^{-1} \curl \vb H + \imath\omega\mu\vb H - \omega^2\mu\epsilon \vb H = \curl \sigma^{-1}\vb j_s$$

* air ($\sigma$ small): $H$ linear (or constant)

## The weak formulation

$$ \int_\Omega \vb w \curl \mu^{-1}\curl \vb E \dd\Omega - \imath\omega\int\vb w \sigma \vb E \dd\Omega = 0 $$

Integration, Greens identity $\int a\laplacian b = -\int \grad a \vdot \grad b - \int a\pdv*{b}{n}$

$$ \int_\Omega \vb w \ldots = \int_\Omega \curl \vb w \vdot (\mu^{-1}\curl \vb E) \dd\Omega + \int \vb n \cross (\mu^{-1}\curl \vb E) \dd \Gamma $$

choose basis that latter term vanishes

$$ \int_\Omega \curl \vb w \vdot (\mu^{-1}\curl \vb E) \dd\Omega  - \imath\omega\int\vb w \sigma \vb E \dd\Omega = 0 $$

## Galerkins method

$$ \vb E = \sum_i u_i \vb u \qqtext{with} \vb w \in \vb u_i $$

$$ \braket{\curl \vb w}{\mu^{-1}\curl\vb u_i} $$

$$ \vb A\vb u =\vb b \qqtext{with} A_{i,j} = \int_\Omega (\curl u_i)\vdot(\mu^{-1}\curl u_j) \dd\Omega $$

## Vectorial solution for EM fields

:::: {.columns}
::: {.column}
![Schwarzbach & Haber (2013)](pics/schwarzbachHaber2013.png)
:::
::: {.column}
* $\vb E \in H^\text{curl}(\Omega)$
* $\vb B \in H^\text{div}(\Omega)$
* natural BC: Dirichlet $\vb n \cross \vb E=0$
* Neumann BC: $\vb n \cross \mu^{-1} \curl \vb E=0$
:::
::::

## Elements used in EM modelling
![Types of elements relevant for EM problems (Spitzer, 2024)](pics/EMelements.png)

## Mesh entities on triangle
![Nodes (yellow), edges (blue) and cells (green) of a triangle](pics/curl/ref-triangle.svg)

[Documentation of DefElements.org](https://defelement.org/elements/raviart-thomas.html)

## Nédélec elements (first kind) on triangle
:::: {.columns}
::: {.column width="33%"}
![](pics/curl/element-Nedelec-variant-equispaced-triangle-0-0.svg)
:::
::: {.column width="33%"}
![](pics/curl/element-Nedelec-variant-equispaced-triangle-0-1.svg)
:::
::: {.column width="33%"}
![](pics/curl/element-Nedelec-variant-equispaced-triangle-0-2.svg)
:::
::::

## Nedelec shape functions

![](pics/curl/curl-element-shapefunctions.png)

## Raviart-Thomas on the triangle

:::: {.columns}
::: {.column width="33%"}
![](pics/curl/element-Raviart-Thomas-variant-equispaced-triangle-0-0.svg)
:::
::: {.column width="33%"}
![](pics/curl/element-Raviart-Thomas-variant-equispaced-triangle-0-1.svg)
:::
::: {.column width="33%"}
![](pics/curl/element-Raviart-Thomas-variant-equispaced-triangle-0-2.svg)
:::
::::


## Mesh entities tetrahedron
![Nodes (orange), edges (blue), faces (green) & cells (purple)](pics/curl/ref-tetrahedron.svg)

[Documentation of DefElements.org](https://defelement.org/elements/raviart-thomas.html)

## Nédélec elements (first kind) on tetrahedron
:::: {.columns}
::: {.column width="23%"}
![](pics/curl/element-Nedelec-variant-equispaced-tetrahedron-0-0.svg)
![](pics/curl/element-Nedelec-variant-equispaced-tetrahedron-0-3.svg)
:::
::: {.column width="23%"}
![](pics/curl/element-Nedelec-variant-equispaced-tetrahedron-0-1.svg)
![](pics/curl/element-Nedelec-variant-equispaced-tetrahedron-0-4.svg)
:::
::: {.column width="23%"}
![](pics/curl/element-Nedelec-variant-equispaced-tetrahedron-0-2.svg)
![](pics/curl/element-Nedelec-variant-equispaced-tetrahedron-0-5.svg)
:::
::::

## Raviart-Thomas elements on tetrahedron
:::: {.columns}
::: {.column width="25%"}
![](pics/curl/element-Raviart-Thomas-variant-equispaced-tetrahedron-0-0.svg)
:::
::: {.column width="25%"}
![](pics/curl/element-Raviart-Thomas-variant-equispaced-tetrahedron-0-1.svg)
:::
::: {.column width="25%"}
![](pics/curl/element-Raviart-Thomas-variant-equispaced-tetrahedron-0-2.svg)
:::
::: {.column width="25%"}
![](pics/curl/element-Raviart-Thomas-variant-equispaced-tetrahedron-0-3.svg)
:::
::::

## Packages

Mesh generation: [TetGen](https://tetgen.org) (3D), [GMsh](https://gmsh.info) (2D/3D)

FE packages: [FEniCS](https://fenicsproject.org), [NETGEN/NGsolve](https://ngsolve.org)

Equation solvers: [Suitesparse](https://doc.sagemath.org/html/en/reference/spkg/suitesparse.html), [MUMPS](https://mumps-solver.org), [SciPy](https://scipy.org)

Computational frameworks: [PetSc](https://petsc.org), [MPI](https://www.mcs.anl.gov/research/projects/mpi/)

EM modelling (and inversion) packages: [Mare2DEM](https://mare2dem.bitbucket.io), [emg3d](https://emg3d.emsig.xyz), GoFEM, [PETGEM](https://petgem.bsc.es/), [custEM](https://custem.readthedocs.io), [SimPEG](https://simpeg.xyz), ModEM, FEMTIC

## FEniCS for pressure & flow

$$ -v\laplacian \vb u + \grad p = \vb f \qquad \div \vb u=0 $$

```
import dolfinx as dfx  # API to FEniCS
import ufl  # Unified form language

lagrange = element("P", mesh.basix_cell(), p) # shape=(3,)
nedelec = element("N1curl", mesh.basix_cell(), p)

u = ufl.TestFunctions(nedelev)
v = ufl.TrialFunctions(nedelec)

var_form = dfx.fem.form((ufl.curl(ur), ufl.curl(vr)) * ufl.dx))

mixed_ele = mixed_element([lagrange, nedelec]) # real imag
MixedSpace = dfx.fem.functionspace(mesh, mixed_ele)

A = dfx.fem.petsc.assemble_matrix(var_form, bcs=self.bcs)
A.assemble()
```


## FEniCS for EM

```
# E lives on edges
ele = element("N1curl", mesh.basix_cell(), p)
# real and imaginary part of E combined
mixed_ele = mixed_element([ele, ele])
MixedSpace = dfx.fem.functionspace(mesh, mixed_ele)
# Sigma lives on Cells
dg_space = dfx.fem.functionspace(mesh, ("DG", 0)) # sigma
para = dfx.fem.Function(dg_space)
para.x.array[:] = sigma_vector
# Trial and test function
vr, vi = ufl.TrialFunctions(MixedSpace)
ur, ui = ufl.TestFunctions(MixedSpace)
# variational form
var_form = dfx.fem.form((
    ufl.inner(mu1 * ufl.curl(ur), ufl.curl(vr)) * ufl.dx -
    omega * ufl.inner(sig * ui, vr) * ufl.dx - omega * ufl.inner(sig * ur, vi) * ufl.dx -
    ufl.inner(mu1 * ufl.curl(ui), ufl.curl(vi)) * ufl.dx))
```

## Post-processing

```
raviart_thomas = dfx.fem.functionspace(
    mesh, element("RT", mesh.basix_cell(), p))

```

## Modelling topography

![Modelling incorporating topography (Rochlitz, 2019)](pics/custem/topomodeling.png)

## Meshing complicated geometries

![Meshing workflow in custEM (Rochlitz et al., 2019)](pics/custem/meshes.png)

## Modelling example

![Modelling example of a conductive dike (Rochlitz et al., 2019)](pics/custem/examples.png)

# Accuracy and refinement

![h and p refinement (Schwarzbach et al. 2011)](pics/schwarzbach_refinement.png)

# Boundary conditions

**Neumann** (implicitly by choice of shape functions)

$\pdv{u}{n}=0$ $\Rightarrow$ $\vb n\cross \curl \vb E = 0$ $\Rightarrow$ $\vb n \cross \vb B=0$

**Dirichlet**

$u=0$ $\Rightarrow$ $\vb n\cross \vb E = 0$ $\Rightarrow$ $\vb n\dotproduct \vb B=0$


## Mixed boundary conditions
So far...

* Dirichlet Boundary conditions $u=u_0$
* Neumann Boundary conditions $\pdv{u}{n}=g_B$<br>

vectorial problems: $\vb n\cdot \vb E=0$ (Neumann) or $\vb\curl \vb E=0$ (Dirichlet)

In general mixed, also called Robin (or impedance convective) BC
$$ a u + b \pdv{u}{n} = c $$

## Example DC resistivity with point source
$$\div \sigma \grad u = \div \vb j = I \delta(\vb r - \vb r_s)$$

solution for homogeneous $\sigma$ on surface: $u=\frac{I}{2\pi\sigma} \frac{1}{|\vb r - \vb r_s|}$

E-field $\vb E=-\frac{I}{2\pi\sigma} \frac{\vb r - \vb r_s}{|\vb r - \vb r_s|^3}$

normal direction $\vb E \cdot \vb n=-\frac{u}{|\vb r - \vb r_s|}\cos \phi$ purely geometric

$$\pdv{u}{n} + \frac{\cos\phi}{|\vb r - \vb r_s|}=0$$

## Perfectly matched layers

::: {.columns}
::: {.column}
![](pics/FDTD_TFSF.png)
:::
::: {.column}
$$ \pdv{x} \rightarrow \frac{1}{1+i\sigma/\omega} \pdv{x}  $$

$$ x \rightarrow x + \frac{i}{\omega}\int^x \sigma(x')\dd x' $$

:::
:::


## Absorbing boundary conditions
wave equation (e.g. in 2D)
$$ \pdv[2]{u}{t} - v^2 \laplacian u = 0 $$

Fourier transform in $t$ and $y$ (boundary direction) $\Rightarrow \omega, k$

$$ \omega^2 \hat{u} - v^2 \pdv[2]{\hat{u}}{x} + v^2 k^2 \hat{u} = 0 $$

ordinary DE with solution $\hat{u}=\sum a_i e^{\lambda x}$ with $\lambda^2 = k^2 - \omega^2/v^2$

# Time-domain EM

* Fourier transform excitation $\Rightarrow$ solve in FD $\Rightarrow$ backtransform
* solve with Time-Stepping: Governing equation

$$ \curl\mu^{-1}\curl \vb e + \sigma \pdv{\vb e}{t} = -\pdv{\vb e_s}{t} $$

$$ \vb K \vb u + \vb M \pdv{u}{t} = \vb s $$

## Implicit time stepping

$$ (\Delta t \vb K + \vb M) \vb u^{n+1} = \vb M u^n +\Delta t \vb s^{n+1} $$

second-order
$$ (2\Delta t \vb K + 3 \vb M) \vb u^{n+2} = \vb M (4 \vb u^{n+1} - \vb u^n) - 2\Delta t \vb s^{n+2} $$

# Appendix

## 2D scalar EM - TM polarization

$$ \curl \sigma^{-1} \curl \vb H + \imath\omega\mu\vb H=\curl\sigma^{-1} \vb j_s$$


::: {.callout-note title="Transverse magnetic (TM) mode"}
Assume the source field is oscillating perpendicular to the modelling plane, i.e.

$\vb H=[H_x, 0, 0]^T e^{\imath\omega t}$.
:::

Then the PDE holds for the scalar $H_x$

$$-\div \sigma^{-1} \grad H_x(y,z) + \imath\omega\mu H_x(y,z) = 0$$

## 2D scalar EM - TE polarization

$$ \curl \mu^{-1}\curl \vb E + \imath\omega\sigma\vb E = \curl \vb j_s$$

::: {.callout-note title="Transverse electric (TE) mode"}
Assume the source field is oscillating perpendicular to the modelling plane, i.e.

$\vb E=[E_x, 0, 0]^T e^{\imath\omega t}$.
:::

Then the PDE holds for the scalar $E_x$

$$-\div \mu^{-1} \grad E_x(y,z) + \imath\omega\sigma E_x(y,z) = 0$$

